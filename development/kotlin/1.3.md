---
layout: page
---

# Kotlin 1.3

## M1 New Feature

### Coroutine

* `buildSequence` and `buildIterator` moved to `kotlin.sequences`.


### Capturing when subject in a variable

* When のところで変数宣言できるようになった。

```kotlin
fun Request.getBody() =
    when (val response = executeRequest()) {
        is Success -> response.body
        is HttpError -> throw HttpException(response.status)
    }
```

### `@JvmStatic` and `@JvmField` can be used in companions of interfaces

* Interface が JVM Static な フィールド、 メンバ を持てるようになった。
    コンパニオンオブジェクトの中で `@JvmStatic`, `@JvmField` が使用可能。
    * `@JvmStatic` を使う場合は、 コンパイラオプション `-jvm-target` を 1.8 以上にする。
    * `@JvmField` を使う場合は、 `public final val` という扱いになる。

```kotlin
interface Service {
    companion object {
        @JvmField
        val ID = 0xF0EF
       
        @JvmStatic
        fun create(): Service = ...
    }
}
```

### Nested declarations in annotation classes

* annotation class が ネストされたクラス、 インターフェース、
    コンパニオンオブジェクトを含むオブジェクトを内包できるようになった。
    * 一つのアノテーションが他のアノテーションをネストできるようになった。
    
```kotlin
annotation class Outer(val param: Inner) {
    annotation class Inner(val value: String)
}
```
 
```kotlin
annotation class Annotation {
    companion object {
        @JvmField
        val timestamp = System.currentTimeMillis()
    }
}
```

```kotlin
annotation class Annotation {
    companion object {
        @JvmField
        val timestamp = System.currentTimeMillis()
    }
}
```

### Constant of Companion object in Basic type

* `Byte`, `Short`, `Int`, `Long`, `Char`: 定数 `SIZE_BITS`, `SIZE_BYTES`
* `Char`
    * `MIN_VALUE`: `\u0000`
    * `MAX_VALUE`: `\uFFFF`

### 関数型

* 引数が255個まで使用可能になった。

### Extension

* `orEmpty()`
    * sequence に追加された
* `isNullOrEmpty`
    * colelction, map, array に追加された。 
    
## M2 Feature

### Standard Library

* `UInt`
* `UByte`
* `UIntArray`
    * `contentEquals`
    * `contentToString`
    * `contentHashCode`
    * `uintArrayOfZeros`
* `UByteArray`
    
### Experimental

* `require`
    * add smart cast function
    * execute lambda once.
* Enhanced New Style
    * Example
        ```kotlin
        fun test(x: List<Int>?) {
            // If the function returns false, the value is definitely not null:
            if (!x.isNullOrEmpty()) {
                println(x.size) // Yay, smart cast to not-null!
            }
        }
        
        fun test(x: Any?) {
            // If the function returns (does not throw), then the argument is true:
            require(x is String) 
            println(x.length) // Smart cast here too!
        }
        ```
    * affected functions
        * `check`
        * `checkNotNull`
        * `require`
        * `requireNotNull`
        * `kotlin.test.assertTrue`
        * `kotlin.test.assertFalse`
        * `kotlin.test.assertNotNull`
        * `isNullOrEmpty`
        * `isNullOrBlank`
* Analyzing variable initialization more accurately
    * 変数の初期化状態について、コンパイラがより正確に判定できるようになった。(コンパイラに起因するエラーが出なくなる)
        * 外のスコープの変数をグローバルに更新できるようになるということなので、あまり好ましくはないと思う。
    * affected functions
        * `run`
        * `let`
        * `with`
        * `apply`
        * `also`
        * `takeIf`
        * `takeUnless`
        * `synchronized`
    * Example
        ```kotlin
        val x: Int
        synchronized(lock) {
            x = 42 // The compiler knows that the lambda is invoked exactly once!
        }
        println(x) // Allowed now, the compiler knows that 'x' is definitely assigned.
        ```